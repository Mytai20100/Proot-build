name: Build Proot

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Intel/AMD x86 32-bit
          - arch: i386
            docker_arch: linux/386
            base_image: alpine:latest
          
          # Intel/AMD x86 64-bit
          - arch: amd64
            docker_arch: linux/amd64
            base_image: alpine:latest
          
          # ARM variants (b·ªè armv5)
          - arch: armv6
            docker_arch: linux/arm/v6
            base_image: alpine:latest
          
          - arch: armv7
            docker_arch: linux/arm/v7
            base_image: alpine:latest
          
          - arch: arm64
            docker_arch: linux/arm64/v8
            base_image: alpine:latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build proot
        run: |
          mkdir -p artifacts
          
          docker run --rm --platform ${{ matrix.docker_arch }} \
            -v $PWD/artifacts:/output \
            ${{ matrix.base_image }} sh -c '
              apk add --no-cache git build-base linux-headers talloc-dev talloc-static python3 upx bsd-compat-headers libarchive-dev
              
              cd /tmp
              git clone --depth 1 --branch v5.4.0 https://github.com/proot-me/proot.git
              cd proot/src
              
              sed -i "1i#include <libgen.h>" cli/cli.c
              
              make proot
              strip proot
              upx --best --lzma proot || true
              
              cp proot /output/proot-${{ matrix.arch }}
              chmod +x /output/proot-${{ matrix.arch }}
            '
      
      - name: Test binary
        run: |
          ls -lh artifacts/
          file artifacts/proot-${{ matrix.arch }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proot-${{ matrix.arch }}
          path: artifacts/proot-${{ matrix.arch }}
          retention-days: 30

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Prepare release
        run: |
          mkdir -p release
          find all-artifacts -name "proot-*" -exec cp {} release/ \;
          ls -lh release/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: Proot Build ${{ github.run_number }}
          body: |
            Proot static binaries for multiple architectures
            
            **Available:** i386, amd64, armv6, armv7, arm64
            
            Build: ${{ github.run_number }}
            Commit: ${{ github.sha }}
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
